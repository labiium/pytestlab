{% set lang = config.theme.language or 'en' %}
<!DOCTYPE html>
<html lang="{{ lang }}">
</html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{{ config.site_description }}">
    <meta name="author" content="{{ config.site_author }}">
    <meta name="robots" content="index, follow">

    <!-- Favicon -->
    <link rel="icon" href="{{ 'img/favicon.ico'|url }}" type="image/x-icon">

    <title>{% if page.title %}{{ page.title }} - {% endif %}{{ config.site_name }}{% if page.is_404 %} - {{ config.extra.t[lang]['404_title'] or 'Page Not Found' }}{% endif %}</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ 'css/theme.css'|url }}">

    <!-- Enhanced Prism.js CSS for LABIIUM Photonic theme -->
    <style>
        /* LABIIUM Photonic Prism.js Theme */
        code[class*="language-"],
        pre[class*="language-"] {
            color: var(--photon-white, #f5f7fa);
            background: none;
            text-shadow: 0 1px rgba(0, 0, 0, 0.3);
            font-family: var(--font-code, 'IBM Plex Mono', Consolas, 'Courier New', monospace);
            font-size: 0.9em;
            text-align: left;
            white-space: pre;
            word-spacing: normal;
            word-break: normal;
            word-wrap: normal;
            line-height: 1.6;
            tab-size: 4;
            hyphens: none;
        }

        .token.comment,
        .token.prolog,
        .token.doctype,
        .token.cdata {
            color: #6b7280;
            font-style: italic;
        }

        .token.punctuation {
            color: #d1d5db;
        }

        .token.property,
        .token.tag,
        .token.constant,
        .token.symbol,
        .token.deleted {
            color: #ef4444;
        }

        .token.boolean,
        .token.number {
            color: #f59e0b;
        }

        .token.selector,
        .token.attr-name,
        .token.string,
        .token.char,
        .token.builtin,
        .token.inserted {
            color: var(--lab-aqua, #04e2dc);
        }

        .token.operator,
        .token.entity,
        .token.url,
        .language-css .token.string,
        .style .token.string,
        .token.variable {
            color: #ec4899;
        }

        .token.atrule,
        .token.attr-value,
        .token.function,
        .token.class-name {
            color: #8b5cf6;
        }

        .token.keyword {
            color: var(--lab-violet, #5333ed);
            font-weight: 600;
        }

        .token.regex,
        .token.important {
            color: #f59e0b;
        }

        .token.important,
        .token.bold {
            font-weight: bold;
        }

        .token.italic {
            font-style: italic;
        }

        .token.entity {
            cursor: help;
        }

        /* Python-specific highlighting */
        .language-python .token.decorator {
            color: var(--lab-violet, #5333ed);
        }

        .language-python .token.triple-quoted-string {
            color: var(--lab-aqua, #04e2dc);
        }

        /* Enhanced notebook-specific styling */
        .nb-input-content .token.keyword,
        .nb-output-content .token.keyword {
            color: var(--lab-violet, #5333ed) !important;
            text-shadow: 0 0 10px rgba(83, 51, 237, 0.3);
        }

        .nb-input-content .token.string,
        .nb-output-content .token.string {
            color: var(--lab-aqua, #04e2dc) !important;
            text-shadow: 0 0 10px rgba(4, 226, 220, 0.3);
        }
    </style>

    <!-- Search styles -->
    <style>
        .search-container {
            position: relative;
            margin-right: 1rem;
        }

        .md-search {
            position: relative;
        }

        .md-search__inner {
            width: 100%;
        }

        .md-search__form {
            position: relative;
            display: flex;
            align-items: center;
            padding: 0 0.5rem;
            height: 2.4rem;
            width: 16rem;
        }

        .md-search__input {
            flex-grow: 1;
            height: 100%;
            background: transparent;
            border: none;
            outline: none;
            padding: 0 0.5rem;
        }

        .md-search__icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1.8rem;
            height: 1.8rem;
            cursor: pointer;
        }

        .md-search__icon svg {
            width: 1.2rem;
            height: 1.2rem;
        }

        .md-search-result {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            width: 24rem;
            max-height: 75vh;
            overflow-y: auto;
            margin-top: 0.5rem;
            z-index: 100;
        }
    </style>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Manrope:wght@800&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Extra head content from plugins -->
    {% block extrahead %}{% endblock %}
</head>
<body{% if page.is_404 %} class="error-page-body"{% endif %}>
    <div id="background-beams"></div>

    <div class="layout">
        <!-- Header / Navigation -->
        <header class="site-header">
            <div class="container">
                <div class="header-content">
                    <div class="logo-container">
                        <a href="{{ nav.homepage.url|url }}" class="site-logo">
                            <img src="{{ 'img/pytestlab_logo.png'|url }}" alt="{{ config.site_name }} Logo">
                            <span class="site-name">{{ config.site_name }}</span>
                        </a>
                    </div>

                    <nav class="nav-primary">
                        <button class="mobile-nav-toggle" aria-label="Toggle navigation">
                            <span class="line"></span>
                            <span class="line"></span>
                            <span class="line"></span>
                        </button>

                        <ul class="nav-links">
                            {% for nav_item in nav %}
                                {% if nav_item.title != "Home" or not page.is_homepage %}
                                    {% if nav_item.children %}
                                        <li class="nav-item dropdown {% if nav_item.active %}active{% endif %}">
                                            <a href="#" class="dropdown-toggle">{{ nav_item.title }}</a>
                                            <ul class="dropdown-menu glass-card">
                                                {% for child in nav_item.children %}
                                                    <li class="{% if child.active %}active{% endif %}">
                                                        <a href="{{ child.url|url }}">{{ child.title }}</a>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </li>
                                    {% else %}
                                        <li class="nav-item {% if nav_item.active %}active{% endif %}">
                                            <a href="{{ nav_item.url|url }}">{{ nav_item.title }}</a>
                                        </li>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </nav>

                    <div class="header-actions">
                        <!-- Search component -->
                        <div class="search-container">
                            <button class="search-button" id="searchButton" aria-label="Open Search">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>

                        <!-- Search Modal -->
                        <div class="search-modal" id="searchModal">
                            <div class="search-modal-content">
                                <form class="search-form">
                                    <input type="text" class="search-input" id="searchInput" placeholder="{{ config.extra.t[lang].search_placeholder or 'Search documentation...' }}" autofocus>
                                    <button type="button" class="search-close" id="searchClose">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </form>
                                <div class="search-results">
                                    <div class="search-results-meta" id="searchResultsMeta">{{ config.extra.t[lang].search_meta or 'Type to start searching' }}</div>
                                    <div id="searchResults"></div>
                                </div>
                            </div>
                        </div>

                        {% if config.repo_url %}
                        <a href="{{ config.repo_url }}" target="_blank" class="beam-button beam-button-sm">
                            <span class="beam-button-text">{{ config.extra.t[lang].footer_github or 'GitHub' }}</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="main-content">
            <div class="container">
                <div class="content-layout">
                    <!-- Sidebar / Table of Contents -->
                    {% if not page.is_404 and not page.is_homepage %}
                    <aside class="sidebar">
                        <div class="glass-card toc-container">
                            <div class="toc-header">
                                <h4>Contents</h4>
                            </div>
                            {% if page.toc %}
                                <ul class="toc">
                                    {% for toc_item in page.toc %}
                                        <li class="toc-item level-{{ toc_item.level }}">
                                            <a href="{{ toc_item.url }}">{{ toc_item.title }}</a>
                                            {% if toc_item.children %}
                                                <ul>
                                                    {% for toc_child in toc_item.children %}
                                                        <li class="toc-item level-{{ toc_child.level }}">
                                                            <a href="{{ toc_child.url }}">{{ toc_child.title }}</a>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    </aside>
                    {% endif %}

                    <!-- Main Content Area -->
                    <div class="page-content glass-card{% if page.is_404 %} full-width{% endif %}{% if page.is_homepage %} full-width{% endif %}">
                        <div class="article">
                            {% if not page.is_404 and not page.is_homepage %}
                            <h1 class="page-title">{{ page.title }}</h1>
                            {% if page.meta.subtitle %}
                                <h2 class="page-subtitle">{{ page.meta.subtitle }}</h2>
                            {% endif %}
                            {% endif %}

                            {% block content %}
                                {{ page.content }}
                            {% endblock %}
                        </div>

                        <!-- Page Navigation (Previous/Next) -->
                        {% if not page.is_404 and not page.is_homepage %}
                        <div class="page-nav">
                            {% if page.previous_page %}
                                <a href="{{ page.previous_page.url|url }}" class="prev-link">
                                    <span class="nav-label">Previous</span>
                                    <span class="nav-title">{{ page.previous_page.title }}</span>
                                </a>
                            {% endif %}

                            {% if page.next_page %}
                                <a href="{{ page.next_page.url|url }}" class="next-link">
                                    <span class="nav-label">Next</span>
                                    <span class="nav-title">{{ page.next_page.title }}</span>
                                </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="site-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-copyright">
                        <p>&copy; {{ build_date_utc.strftime('%Y') }} {{ config.site_author }}. {{ config.extra.t[lang].footer_copyright or 'All rights reserved.' }}</p>
                        <p>{{ config.extra.t[lang].footer_brand_desc or 'A modern, async-first Python toolbox for laboratory test-and-measurement automation, data management, and analysis.' }}</p>
                    </div>

                    <div class="footer-links">
                        {% if config.repo_url %}
                            <a href="{{ config.repo_url }}" target="_blank">{{ config.extra.t[lang].footer_github }}</a>
                        {% endif %}
                        {% if config.site_url %}
                            <a href="{{ config.site_url }}">{{ config.extra.t[lang].footer_about }}</a>
                        {% endif %}
                        <a href="{{ 'changelog/'|url }}">{{ config.extra.t[lang].footer_changelog or 'Changelog' }}</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- JavaScript -->
    <script src="{{ 'js/theme.js'|url }}"></script>

    <!-- Search and Enhanced functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Search Modal ---
            const searchButton = document.getElementById('searchButton');
            const searchModal = document.getElementById('searchModal');
            const searchClose = document.getElementById('searchClose');
            const searchInput = document.getElementById('searchInput');
            let searchIndex = null;

            // Load search index with improved path resolution
            const currentPath = window.location.pathname;
            const baseUrl = currentPath.replace(/\/[^\/]*$/, '');

            // Try multiple search index paths
            const searchPaths = [
                'search/search_index.json',
                '../search/search_index.json',
                './search/search_index.json',
                '/search/search_index.json',
                baseUrl + '/search/search_index.json'
            ];

            const tryLoadSearchIndex = async () => {
                for (const path of searchPaths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            searchIndex = await response.json();
                            console.log('Search index loaded from:', path);
                            return;
                        }
                    } catch (error) {
                        // Continue to next path
                    }
                }
                console.log('Search functionality disabled - no search index found');
            };

            tryLoadSearchIndex();

            if (searchButton && searchModal && searchClose) {
                searchButton.addEventListener('click', function() {
                    searchModal.classList.add('active');
                    setTimeout(() => {
                        searchInput.focus();
                    }, 100);
                });

                searchClose.addEventListener('click', function() {
                    searchModal.classList.remove('active');
                });

                // Close on escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && searchModal.classList.contains('active')) {
                        searchModal.classList.remove('active');
                    }
                });
            }

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.trim().toLowerCase();
                    const searchResultsMeta = document.getElementById('searchResultsMeta');
                    const searchResults = document.getElementById('searchResults');

                    if (query.length > 1) {
                        searchResultsMeta.textContent = 'Searching...';
                        searchResults.innerHTML = '';

                        if (searchIndex) {
                            const results = performSearch(query, searchIndex);
                            displaySearchResults(results, searchResultsMeta, searchResults);
                        } else {
                            searchResultsMeta.textContent = 'Loading search index...';
                            searchResults.innerHTML = '<div class="search-result-item"><p style="color: var(--lab-aqua); padding: 1rem;">Search index is loading. If this persists, make sure the site has been built with <code>mkdocs build</code>.</p></div>';
                        }
                    } else {
                        searchResultsMeta.textContent = '{{ config.extra.t[lang].search_start or 'Type to start searching' }}';
                        searchResults.innerHTML = '';
                    }
                });
            }

            function performSearch(query, index) {
                const results = [];
                // Handle different search index formats
                const docs = index.docs || index.articles || [];

                docs.forEach((doc, i) => {
                    const title = (doc.title || '').toLowerCase();
                    const text = (doc.text || doc.content || '').toLowerCase();
                    let location = doc.location || doc.url || '#';

                    // Fix URL resolution for search results
                    if (location && location !== '#') {
                        // Remove leading slash if present and ensure proper relative path
                        location = location.replace(/^\//, '');

                        // If we're not on the root page, adjust the path
                        const currentPath = window.location.pathname;
                        if (currentPath !== '/' && !currentPath.endsWith('/index.html')) {
                            // Count directory depth to add proper ../
                            const depth = (currentPath.match(/\//g) || []).length - 1;
                            if (depth > 0 && !location.startsWith('../')) {
                                location = '../'.repeat(depth) + location;
                            }
                        }
                    }

                    if (title.includes(query) || text.includes(query)) {
                        const titleIndex = title.indexOf(query);
                        const textIndex = text.indexOf(query);
                        const score = (titleIndex >= 0 ? 10 : 0) + (textIndex >= 0 ? 1 : 0);

                        results.push({
                            title: doc.title || 'Untitled',
                            location: location,
                            text: text || 'No description available',
                            score: score
                        });
                    }
                });

                return results.sort((a, b) => b.score - a.score).slice(0, 10);
            }

            function displaySearchResults(results, metaElement, resultsElement) {
                if (results.length > 0) {
                    metaElement.textContent = '{{ config.extra.t[lang].search_results_found or '{count} result(s) found' }}'.replace('{count}', results.length);

                    resultsElement.innerHTML = results.map(result => {
                        // Ensure the search result text is properly escaped
                        const escapedTitle = result.title.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const escapedText = result.text.substring(0, 150).replace(/</g, '&lt;').replace(/>/g, '&gt;');

                        return `
                            <div class="search-result-item">
                                <a href="${result.location}" class="search-result-link">
                                    <div class="search-result-title">${escapedTitle}</div>
                                    <div class="search-result-text">${escapedText}...</div>
                                </a>
                            </div>
                        `;
                    }).join('');

                    // Add click handlers to close search modal when clicking results
                    setTimeout(() => {
                        const searchResultLinks = resultsElement.querySelectorAll('.search-result-link');
                        searchResultLinks.forEach(link => {
                            link.addEventListener('click', () => {
                                searchModal.classList.remove('active');
                            });
                        });
                    }, 100);
                } else {
                    metaElement.textContent = '{{ config.extra.t[lang].search_no_results or 'No results found' }}';
                    resultsElement.innerHTML = '<div class="search-result-item"><div style="padding: 1rem; color: rgba(255, 255, 255, 0.6); text-align: center;">Try different keywords or check your spelling.</div></div>';
                }
            }
        });
    </script>

    {% if page.is_404 %}
    <style>
        .content-layout {
            grid-template-columns: 1fr !important;
        }

        .full-width {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .error-page-body #background-beams {
            background: radial-gradient(ellipse 80% 50% at 50% 50%, rgba(83, 51, 237, 0.2), transparent),
                        radial-gradient(ellipse 60% 50% at 50% 50%, rgba(4, 226, 220, 0.15), transparent);
        }
    </style>
    {% endif %}

    <!-- Extra scripts from plugins -->
    {% block extrascripts %}{% endblock %}

    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- Enhanced Prism.js Configuration -->
    <script>
        // Configure Prism.js for better syntax highlighting
        if (window.Prism) {
            // Set autoloader path
            Prism.plugins.autoloader.languages_path = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/';

            // Ensure manual highlighting is available
            Prism.manual = false;

            // Add custom YAML token patterns
            if (Prism.languages.yaml) {
                Prism.languages.yaml.key = {
                    pattern: /(\s*(?:^|[:\-,[{\r\n?])[ \t]*)[^\r\n{[\\]},#\s]+?(?=\s*:\s)/,
                    lookbehind: true,
                    alias: 'atrule'
                };
            }

            // Force re-highlighting after all languages are loaded
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(function() {
                    if (window.Prism && window.Prism.highlightAll) {
                        Prism.highlightAll();
                    }
                }, 500);
            });
        }
    </script>
</body>
</html>
