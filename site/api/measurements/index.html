<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Scientific test & measurement toolbox for Python.">
    <meta name="author" content="LABIIUM">
    <meta name="robots" content="index, follow">

    <!-- Favicon -->
    <link rel="icon" href="../../img/favicon.ico" type="image/x-icon">

    <title>Measurements - PyTestLab</title>

    <!-- CSS -->
    <link rel="stylesheet" href="../../css/theme.css">

    <!-- Prism.js CSS for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

    <!-- Search styles -->
    <style>
        .search-container {
            position: relative;
            margin-right: 1rem;
        }

        .md-search {
            position: relative;
        }

        .md-search__inner {
            width: 100%;
        }

        .md-search__form {
            position: relative;
            display: flex;
            align-items: center;
            padding: 0 0.5rem;
            height: 2.4rem;
            width: 16rem;
        }

        .md-search__input {
            flex-grow: 1;
            height: 100%;
            background: transparent;
            border: none;
            outline: none;
            padding: 0 0.5rem;
        }

        .md-search__icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1.8rem;
            height: 1.8rem;
            cursor: pointer;
        }

        .md-search__icon svg {
            width: 1.2rem;
            height: 1.2rem;
        }

        .md-search-result {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            width: 24rem;
            max-height: 75vh;
            overflow-y: auto;
            margin-top: 0.5rem;
            z-index: 100;
        }
    </style>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Manrope:wght@800&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Extra head content from plugins -->
    
</head>
<body>
    <div id="background-beams"></div>

    <div class="layout">
        <!-- Header / Navigation -->
        <header class="site-header">
            <div class="container">
                <div class="header-content">
                    <div class="logo-container">
                        <a href="../.." class="site-logo">
                            <img src="../../img/pytestlab_logo.png" alt="PyTestLab Logo">
                            <span class="site-name">PyTestLab</span>
                        </a>
                    </div>

                    <nav class="nav-primary">
                        <button class="mobile-nav-toggle" aria-label="Toggle navigation">
                            <span class="line"></span>
                            <span class="line"></span>
                            <span class="line"></span>
                        </button>

                        <ul class="nav-links">
                            
                                
                            
                                
                                    
                                        <li class="nav-item dropdown ">
                                            <a href="#" class="dropdown-toggle">Docs</a>
                                            <ul class="dropdown-menu glass-card">
                                                
                                                    <li class="">
                                                        <a href="../../installation/">Installation</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/getting_started/">Getting Started</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/async_vs_sync/">Async vs. Sync</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/connecting/">Connecting to Instruments</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/simulation/">Simulation Mode</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/bench_descriptors/">Bench Descriptors</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/errors/">Error Handling</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/uncertainty/">Handling Uncertainty</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/cli/">Command-Line Interface</a>
                                                    </li>
                                                
                                            </ul>
                                        </li>
                                    
                                
                            
                                
                                    
                                        <li class="nav-item dropdown ">
                                            <a href="#" class="dropdown-toggle">Tutorials</a>
                                            <ul class="dropdown-menu glass-card">
                                                
                                                    <li class="">
                                                        <a href="../../tutorials/10_minute_tour/">10 Minute Tour of PyTestLab</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../tutorials/compliance/">PyTestLab Compliance and Audit Tutorial</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../tutorials/custom_validations/">Creating and Using Custom Validation Rules in PyTestLab</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../tutorials/profile_creation/">Creating Custom Instrument Profiles in PyTestLab</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../tutorials/smartbench/">SmartBench Example</a>
                                                    </li>
                                                
                                            </ul>
                                        </li>
                                    
                                
                            
                                
                                    
                                        <li class="nav-item dropdown active">
                                            <a href="#" class="dropdown-toggle">API</a>
                                            <ul class="dropdown-menu glass-card">
                                                
                                                    <li class="">
                                                        <a href="../instruments/">Instruments</a>
                                                    </li>
                                                
                                                    <li class="active">
                                                        <a href="./">Measurements</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../experiments/">Experiments & Database</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../backends/">Backends</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../config/">Configuration</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../errors/">Errors</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../common/">Common Utilities</a>
                                                    </li>
                                                
                                            </ul>
                                        </li>
                                    
                                
                            
                                
                                    
                                        <li class="nav-item dropdown ">
                                            <a href="#" class="dropdown-toggle">Instruments</a>
                                            <ul class="dropdown-menu glass-card">
                                                
                                                    <li class="">
                                                        <a href="../../profiles/gallery/">Profile Gallery</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../profiles/creating/">Creating Profiles</a>
                                                    </li>
                                                
                                            </ul>
                                        </li>
                                    
                                
                            
                                
                                    
                                        <li class="nav-item dropdown ">
                                            <a href="#" class="dropdown-toggle">Community</a>
                                            <ul class="dropdown-menu glass-card">
                                                
                                                    <li class="">
                                                        <a href="../../contributing/">Contributing</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../changelog/">Changelog</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../CODE_OF_CONDUCT/">Code of Conduct</a>
                                                    </li>
                                                
                                            </ul>
                                        </li>
                                    
                                
                            
                        </ul>
                    </nav>

                    <div class="header-actions">
                        <!-- Search component -->
                        <div class="search-container">
                            <button class="search-button" id="searchButton" aria-label="Open Search">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>

                        <!-- Search Modal -->
                        <div class="search-modal" id="searchModal">
                            <div class="search-modal-content">
                                <form class="search-form">
                                    <input type="text" class="search-input" id="searchInput" placeholder="Search documentation..." autofocus>
                                    <button type="button" class="search-close" id="searchClose">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </form>
                                <div class="search-results">
                                    <div class="search-results-meta" id="searchResultsMeta">Type to start searching</div>
                                    <div id="searchResults"></div>
                                </div>
                            </div>
                        </div>

                        
                        <a href="https://github.com/pytestlab/pytestlab" target="_blank" class="beam-button beam-button-sm">
                            <span class="beam-button-text">GitHub</span>
                        </a>
                        
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="main-content">
            <div class="container">
                <div class="content-layout">
                    <!-- Sidebar / Table of Contents -->
                    
                    <aside class="sidebar">
                        <div class="glass-card toc-container">
                            <div class="toc-header">
                                <h4>Contents</h4>
                            </div>
                            
                                <ul class="toc">
                                    
                                        <li class="toc-item level-1">
                                            <a href="#measurement-session">Measurement Session</a>
                                            
                                                <ul>
                                                    
                                                        <li class="toc-item level-2">
                                                            <a href="#overview">Overview</a>
                                                        </li>
                                                    
                                                        <li class="toc-item level-2">
                                                            <a href="#api-reference">API Reference</a>
                                                        </li>
                                                    
                                                        <li class="toc-item level-2">
                                                            <a href="#pytestlab.measurements.MeasurementSession">MeasurementSession</a>
                                                        </li>
                                                    
                                                        <li class="toc-item level-2">
                                                            <a href="#example-usage">Example Usage</a>
                                                        </li>
                                                    
                                                        <li class="toc-item level-2">
                                                            <a href="#key-features">Key Features</a>
                                                        </li>
                                                    
                                                </ul>
                                            
                                        </li>
                                    
                                </ul>
                            
                        </div>
                    </aside>
                    

                    <!-- Main Content Area -->
                    <div class="page-content glass-card">
                        <div class="article">
                            
                            <h1 class="page-title">Measurements</h1>
                            
                            

                            
                                <h1 id="measurement-session">Measurement Session</h1>
<p>The <code>MeasurementSession</code> class in PyTestLab provides a high-level, context-managed interface for orchestrating complex measurement workflows. It is designed to coordinate multiple instruments, manage experiment metadata, and ensure reproducibility and traceability of your measurements.</p>
<hr />
<h2 id="overview">Overview</h2>
<p>A <code>MeasurementSession</code> encapsulates:</p>
<ul>
<li>The set of instruments involved in a measurement.</li>
<li>Experiment metadata (operator, DUT, environmental conditions, etc.).</li>
<li>The sequence of measurement steps and their results.</li>
<li>Automatic logging and database integration.</li>
</ul>
<p>This abstraction is ideal for automating multi-instrument experiments, batch measurements, or compliance/audit scenarios.</p>
<hr />
<h2 id="api-reference">API Reference</h2>


<div class="doc doc-object doc-class">



<h2 id="pytestlab.measurements.MeasurementSession" class="doc doc-heading">
              <code class="highlight language-python">pytestlab.measurements.MeasurementSession(name=None, description='', tz='UTC', *, bench=None)</code>

</h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="contextlib.AbstractAsyncContextManager">AbstractAsyncContextManager</span></code>, <code><span title="contextlib.AbstractContextManager">AbstractContextManager</span></code></p>


        <p>Core builder â€“ read the extensive doc-string in earlier assistant response
for design details.
Now supports asynchronous operations for sweeps.</p>







                  <details class="quote">
                    <summary>Source code in <code>pytestlab/measurements/session.py</code></summary>
                    <pre class="highlight"><code class="language-python">def __init__(
    self,
    name: Optional[str] = None,
    description: str = "",
    tz: str = "UTC",
    *,
    bench: Optional[Bench] = None,
) -&gt; None:
    self.name = name or "Untitled"
    self.description = description
    self.tz = tz
    self.created_at = datetime.now().astimezone().isoformat()
    self._parameters: Dict[str, _Parameter] = {}
    self._instruments: Dict[str, _InstrumentRecord] = {}
    self._meas_funcs: List[Tuple[str, T_MeasFunc]] = []
    self._data_rows: List[Dict[str, Any]] = []
    self._experiment: Optional[Experiment] = None
    self._has_run = False
    self._bench = bench

    # Inherit experiment data from bench if available
    if bench is not None and bench.experiment is not None:
        # Assign bench experiment properties
        self._experiment = bench.experiment
        self.name = bench.experiment.name
        self.description = bench.experiment.description

    # Set up instruments
    if self._bench:
        # Print debug info
        print(f"DEBUG: Setting up {len(self._bench.instruments)} instruments from bench")
        for alias, inst in self._bench.instruments.items():
            self._instruments[alias] = _InstrumentRecord(
                alias=alias,
                resource=f"bench:{alias}",
                instance=inst,
                auto_close=False,
            )</code></pre>
                  </details>



  <div class="doc doc-children">





<h3 id="pytestlab.measurements.MeasurementSession-attributes">Attributes</h3>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.measurements.MeasurementSession.created_at" class="doc doc-heading">
            <code class="highlight language-python">created_at = datetime.now().astimezone().isoformat()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.measurements.MeasurementSession.data" class="doc doc-heading">
            <code class="highlight language-python">data</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.measurements.MeasurementSession.description" class="doc doc-heading">
            <code class="highlight language-python">description = description</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.measurements.MeasurementSession.name" class="doc doc-heading">
            <code class="highlight language-python">name = name or 'Untitled'</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.measurements.MeasurementSession.tz" class="doc doc-heading">
            <code class="highlight language-python">tz = tz</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<h3 id="pytestlab.measurements.MeasurementSession-functions">Functions</h3>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.measurements.MeasurementSession.__aenter__" class="doc doc-heading">
            <code class="highlight language-python">__aenter__()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/measurements/session.py</code></summary>
              <pre class="highlight"><code class="language-python">async def __aenter__(self) -&gt; "MeasurementSession":  # noqa: D401
    return self</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.measurements.MeasurementSession.__aexit__" class="doc doc-heading">
            <code class="highlight language-python">__aexit__(exc_type, exc, tb)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/measurements/session.py</code></summary>
              <pre class="highlight"><code class="language-python">async def __aexit__(self, exc_type, exc, tb) -&gt; bool:  # noqa: D401
    await self._disconnect_all_instruments()
    return False</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.measurements.MeasurementSession.__enter__" class="doc doc-heading">
            <code class="highlight language-python">__enter__()</code>

</h4>


    <div class="doc doc-contents ">

        <p>Synchronous context manager entry.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/measurements/session.py</code></summary>
              <pre class="highlight"><code class="language-python">def __enter__(self) -&gt; "MeasurementSession":  # noqa: D401
    """Synchronous context manager entry."""
    return self</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.measurements.MeasurementSession.__exit__" class="doc doc-heading">
            <code class="highlight language-python">__exit__(exc_type, exc, tb)</code>

</h4>


    <div class="doc doc-contents ">

        <p>Synchronous context manager exit.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/measurements/session.py</code></summary>
              <pre class="highlight"><code class="language-python">def __exit__(self, exc_type, exc, tb) -&gt; bool:  # noqa: D401
    """Synchronous context manager exit."""
    # Use asyncio to run the async disconnect method synchronously
    try:
        loop = asyncio.get_event_loop()
        if loop.is_running():
            # Create a new loop if we're already in a running event loop
            loop = asyncio.new_event_loop()
            loop.run_until_complete(self._disconnect_all_instruments())
            loop.close()
        else:
            loop.run_until_complete(self._disconnect_all_instruments())
    except Exception:  # noqa: BLE001
        pass  # Keep original error handling behavior
    return False</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.measurements.MeasurementSession.acquire" class="doc doc-heading">
            <code class="highlight language-python">acquire(func=None, /, *, name=None)</code>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/measurements/session.py</code></summary>
              <pre class="highlight"><code class="language-python">def acquire(self, func: T_MeasFunc | None = None, /, *, name: str | None = None):
    if func is None:  # decorator usage
        return lambda f: self.acquire(f, name=name)

    reg_name = name or func.__name__
    if any(n == reg_name for n, _ in self._meas_funcs):
        raise ValueError(f"Measurement '{reg_name}' already registered.")
    self._meas_funcs.append((reg_name, func))
    return func</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.measurements.MeasurementSession.instrument" class="doc doc-heading">
            <code class="highlight language-python">instrument(alias, config_key, /, **kw)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/measurements/session.py</code></summary>
              <pre class="highlight"><code class="language-python">async def instrument(self, alias: str, config_key: str, /, **kw) -&gt; Any:
    if alias in self._instruments:
        record = self._instruments[alias]
        if not record.resource.startswith("bench:"):
            raise ValueError(f"Instrument alias '{alias}' already in use.")
        return record.instance
    if self._bench:
        raise ValueError(
            f"Instrument '{alias}' not found on the bench. "
            "When using a bench, all instruments must be defined in the bench configuration."
        )
    inst = await AutoInstrument.from_config(config_key, **kw)
    self._instruments[alias] = _InstrumentRecord(alias, config_key, inst)
    return inst</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.measurements.MeasurementSession.parameter" class="doc doc-heading">
            <code class="highlight language-python">parameter(name, values, /, *, unit=None, notes='')</code>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/measurements/session.py</code></summary>
              <pre class="highlight"><code class="language-python">def parameter(self, name: str, values: T_ParamIterable, /, *, unit: str | None = None, notes: str = "") -&gt; None:
    if name in self._parameters:
        raise ValueError(f"Parameter '{name}' already exists.")
    if callable(values) and not isinstance(values, (list, tuple, np.ndarray)):
        values = list(values())
    else:
        values = list(values)
    self._parameters[name] = _Parameter(name, values, unit, notes)</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.measurements.MeasurementSession.run" class="doc doc-heading">
            <code class="highlight language-python">run(show_progress=True)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/measurements/session.py</code></summary>
              <pre class="highlight"><code class="language-python">async def run(self, show_progress: bool = True) -&gt; Experiment:
    if not self._parameters:
        raise RuntimeError("No parameters defined.")
    if not self._meas_funcs:
        raise RuntimeError("No measurement functions registered.")

    names = [p.name for p in self._parameters.values()]
    value_lists = [p.values for p in self._parameters.values()]
    combinations = list(itertools.product(*value_lists))

    self._data_rows = [{}] * len(combinations)  # pre-allocate
    iterator = tqdm(enumerate(combinations), total=len(combinations), desc="Measurement sweep", disable=not show_progress)

    for idx, combo in iterator:
        param_ctx = dict(zip(names, combo, strict=True))
        row: Dict[str, Any] = {**param_ctx, "timestamp": time.time()}

        for meas_name, func in self._meas_funcs:
            sig = inspect.signature(func)
            kwargs = {n: v for n, v in param_ctx.items() if n in sig.parameters}
            for alias, inst_rec in self._instruments.items():
                if alias in sig.parameters:
                    kwargs[alias] = inst_rec.instance
            if "ctx" in sig.parameters:
                kwargs["ctx"] = row
            res = await func(**kwargs)
            if not isinstance(res, Mapping):
                raise TypeError(f"Measurement '{meas_name}' returned {type(res)}, expected Mapping.")
            for key, val in res.items():
                col = key if key not in row else f"{meas_name}.{key}"
                row[col] = val

        self._data_rows[idx] = row
        # Yield control to the event loop periodically in long sweeps
        await asyncio.sleep(0)


    self._has_run = True
    self._build_experiment()
    if self._bench and self._bench.db:
        await self._bench.save_experiment()
    return self._experiment</code></pre>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="example-usage">Example Usage</h2>
<pre class="highlight"><code class="language-python">import asyncio
from pytestlab.measurements import MeasurementSession
from pytestlab.instruments import AutoInstrument

async def main():
    # Create instrument instances (simulated for this example)
    dmm = await AutoInstrument.from_config("keysight/EDU34450A", simulate=True)
    psu = await AutoInstrument.from_config("keysight/EDU36311A", simulate=True)
    await dmm.connect_backend()
    await psu.connect_backend()

    # Start a measurement session
    async with MeasurementSession(
        instruments={"dmm": dmm, "psu": psu},
        metadata={"operator": "Alice", "experiment": "Power Supply Test"}
    ) as session:
        # Configure instruments
        await psu.channel(1).set(voltage=3.3, current_limit=0.5).on()
        # Perform measurement
        voltage = await dmm.measure_voltage_dc()
        # Record result in the session
        session.record("dmm_voltage", voltage)

        # ... additional steps ...

    # Session automatically logs results and closes instruments

asyncio.run(main())</code></pre>
<hr />
<h2 id="key-features">Key Features</h2>
<ul>
<li><strong>Async Context Management:</strong> Ensures all resources are properly initialized and cleaned up.</li>
<li><strong>Metadata Tracking:</strong> Attach arbitrary metadata to each session for traceability.</li>
<li><strong>Result Recording:</strong> Store and retrieve results by key for later analysis or database storage.</li>
<li><strong>Integration:</strong> Works seamlessly with PyTestLab's database and experiment modules.</li>
</ul>
<hr />
<p>For more advanced usage, see the <a href="../experiments/">Experiments &amp; Sweeps API</a> and the <a href="../../tutorials/10_minute_tour/">10-Minute Tour</a>.</p>
                            
                        </div>

                        <!-- Page Navigation (Previous/Next) -->
                        
                        <div class="page-nav">
                            
                                <a href="../instruments/" class="prev-link">
                                    <span class="nav-label">Previous</span>
                                    <span class="nav-title">Instruments</span>
                                </a>
                            

                            
                                <a href="../experiments/" class="next-link">
                                    <span class="nav-label">Next</span>
                                    <span class="nav-title">Experiments & Database</span>
                                </a>
                            
                        </div>
                        
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="site-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-copyright">
                        <p>&copy; 2025 LABIIUM. All rights reserved.</p>
                        <p>PyTestLab is an open-source project.</p>
                    </div>

                    <div class="footer-links">
                        
                            <a href="https://github.com/pytestlab/pytestlab" target="_blank">GitHub</a>
                        
                        
                        <a href="../../changelog/">Changelog</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- JavaScript -->
    <script src="../../js/theme.js"></script>

    <!-- Search and Enhanced functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Search Modal ---
            const searchButton = document.getElementById('searchButton');
            const searchModal = document.getElementById('searchModal');
            const searchClose = document.getElementById('searchClose');
            const searchInput = document.getElementById('searchInput');
            let searchIndex = null;

            // Load search index with improved path resolution
            const currentPath = window.location.pathname;
            const baseUrl = currentPath.replace(/\/[^\/]*$/, '');

            // Try multiple search index paths
            const searchPaths = [
                'search/search_index.json',
                '../search/search_index.json',
                './search/search_index.json',
                '/search/search_index.json',
                baseUrl + '/search/search_index.json'
            ];

            const tryLoadSearchIndex = async () => {
                for (const path of searchPaths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            searchIndex = await response.json();
                            console.log('Search index loaded from:', path);
                            return;
                        }
                    } catch (error) {
                        // Continue to next path
                    }
                }
                console.log('Search functionality disabled - no search index found');
            };

            tryLoadSearchIndex();

            if (searchButton && searchModal && searchClose) {
                searchButton.addEventListener('click', function() {
                    searchModal.classList.add('active');
                    setTimeout(() => {
                        searchInput.focus();
                    }, 100);
                });

                searchClose.addEventListener('click', function() {
                    searchModal.classList.remove('active');
                });

                // Close on escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && searchModal.classList.contains('active')) {
                        searchModal.classList.remove('active');
                    }
                });
            }

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.trim().toLowerCase();
                    const searchResultsMeta = document.getElementById('searchResultsMeta');
                    const searchResults = document.getElementById('searchResults');

                    if (query.length > 1) {
                        searchResultsMeta.textContent = 'Searching...';
                        searchResults.innerHTML = '';

                        if (searchIndex) {
                            const results = performSearch(query, searchIndex);
                            displaySearchResults(results, searchResultsMeta, searchResults);
                        } else {
                            searchResultsMeta.textContent = 'Loading search index...';
                            searchResults.innerHTML = '<div class="search-result-item"><p style="color: var(--lab-aqua); padding: 1rem;">Search index is loading. If this persists, make sure the site has been built with <code>mkdocs build</code>.</p></div>';
                        }
                    } else {
                        searchResultsMeta.textContent = 'Type to start searching';
                        searchResults.innerHTML = '';
                    }
                });
            }

            function performSearch(query, index) {
                const results = [];
                // Handle different search index formats
                const docs = index.docs || index.articles || [];

                docs.forEach((doc, i) => {
                    const title = (doc.title || '').toLowerCase();
                    const text = (doc.text || doc.content || '').toLowerCase();
                    let location = doc.location || doc.url || '#';

                    // Fix URL resolution for search results
                    if (location && location !== '#') {
                        // Remove leading slash if present and ensure proper relative path
                        location = location.replace(/^\//, '');

                        // If we're not on the root page, adjust the path
                        const currentPath = window.location.pathname;
                        if (currentPath !== '/' && !currentPath.endsWith('/index.html')) {
                            // Count directory depth to add proper ../
                            const depth = (currentPath.match(/\//g) || []).length - 1;
                            if (depth > 0 && !location.startsWith('../')) {
                                location = '../'.repeat(depth) + location;
                            }
                        }
                    }

                    if (title.includes(query) || text.includes(query)) {
                        const titleIndex = title.indexOf(query);
                        const textIndex = text.indexOf(query);
                        const score = (titleIndex >= 0 ? 10 : 0) + (textIndex >= 0 ? 1 : 0);

                        results.push({
                            title: doc.title || 'Untitled',
                            location: location,
                            text: text || 'No description available',
                            score: score
                        });
                    }
                });

                return results.sort((a, b) => b.score - a.score).slice(0, 10);
            }

            function displaySearchResults(results, metaElement, resultsElement) {
                if (results.length > 0) {
                    metaElement.textContent = `${results.length} result${results.length > 1 ? 's' : ''} found`;

                    resultsElement.innerHTML = results.map(result => {
                        // Ensure the search result text is properly escaped
                        const escapedTitle = result.title.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const escapedText = result.text.substring(0, 150).replace(/</g, '&lt;').replace(/>/g, '&gt;');

                        return `
                            <div class="search-result-item">
                                <a href="${result.location}" class="search-result-link">
                                    <div class="search-result-title">${escapedTitle}</div>
                                    <div class="search-result-text">${escapedText}...</div>
                                </a>
                            </div>
                        `;
                    }).join('');

                    // Add click handlers to close search modal when clicking results
                    setTimeout(() => {
                        const searchResultLinks = resultsElement.querySelectorAll('.search-result-link');
                        searchResultLinks.forEach(link => {
                            link.addEventListener('click', () => {
                                searchModal.classList.remove('active');
                            });
                        });
                    }, 100);
                } else {
                    metaElement.textContent = 'No results found';
                    resultsElement.innerHTML = '<div class="search-result-item"><div style="padding: 1rem; color: rgba(255, 255, 255, 0.6); text-align: center;">Try different keywords or check your spelling.</div></div>';
                }
            }

            // --- Enhanced Code Block Copy functionality ---
            const codeBlocks = document.querySelectorAll('pre');
            codeBlocks.forEach(block => {
                // Add copy button
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>Copy';
                copyButton.setAttribute('aria-label', 'Copy code to clipboard');

                copyButton.addEventListener('click', () => {
                    const code = block.querySelector('code')?.textContent || block.textContent;

                    navigator.clipboard.writeText(code).then(() => {
                        copyButton.classList.add('copied');
                        copyButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg>Copied!';

                        setTimeout(() => {
                            copyButton.classList.remove('copied');
                            copyButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>Copy';
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                    });
                });

                block.appendChild(copyButton);

                // Add language indicator
                const language = block.querySelector('code')?.className.match(/language-(\w+)/)?.[1];
                if (language) {
                    const langBadge = document.createElement('div');
                    langBadge.className = 'lang-badge';

                    // Format language name to be more readable
                    const langMap = {
                        'py': 'Python',
                        'js': 'JavaScript',
                        'ts': 'TypeScript',
                        'html': 'HTML',
                        'css': 'CSS',
                        'yaml': 'YAML',
                        'json': 'JSON',
                        'bash': 'Shell',
                        'sh': 'Shell',
                        'sql': 'SQL',
                        'cpp': 'C++'
                    };

                    const displayLang = langMap[language] || language.charAt(0).toUpperCase() + language.slice(1);
                    langBadge.textContent = displayLang;
                    block.appendChild(langBadge);
                }
            });
        });
    </script>

    

    <!-- Extra scripts from plugins -->
    

    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>