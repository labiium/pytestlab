<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Scientific test & measurement toolbox for Python.">
    <meta name="author" content="LABIIUM">
    <meta name="robots" content="index, follow">

    <!-- Favicon -->
    <link rel="icon" href="../../img/favicon.ico" type="image/x-icon">

    <title>Backends - PyTestLab</title>

    <!-- CSS -->
    <link rel="stylesheet" href="../../css/theme.css">

    <!-- Prism.js CSS for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

    <!-- Search styles -->
    <style>
        .search-container {
            position: relative;
            margin-right: 1rem;
        }

        .md-search {
            position: relative;
        }

        .md-search__inner {
            width: 100%;
        }

        .md-search__form {
            position: relative;
            display: flex;
            align-items: center;
            padding: 0 0.5rem;
            height: 2.4rem;
            width: 16rem;
        }

        .md-search__input {
            flex-grow: 1;
            height: 100%;
            background: transparent;
            border: none;
            outline: none;
            padding: 0 0.5rem;
        }

        .md-search__icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1.8rem;
            height: 1.8rem;
            cursor: pointer;
        }

        .md-search__icon svg {
            width: 1.2rem;
            height: 1.2rem;
        }

        .md-search-result {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            width: 24rem;
            max-height: 75vh;
            overflow-y: auto;
            margin-top: 0.5rem;
            z-index: 100;
        }
    </style>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Manrope:wght@800&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Extra head content from plugins -->
    
</head>
<body>
    <div id="background-beams"></div>

    <div class="layout">
        <!-- Header / Navigation -->
        <header class="site-header">
            <div class="container">
                <div class="header-content">
                    <div class="logo-container">
                        <a href="../.." class="site-logo">
                            <img src="../../img/pytestlab_logo.png" alt="PyTestLab Logo">
                            <span class="site-name">PyTestLab</span>
                        </a>
                    </div>

                    <nav class="nav-primary">
                        <button class="mobile-nav-toggle" aria-label="Toggle navigation">
                            <span class="line"></span>
                            <span class="line"></span>
                            <span class="line"></span>
                        </button>

                        <ul class="nav-links">
                            
                                
                            
                                
                                    
                                        <li class="nav-item dropdown ">
                                            <a href="#" class="dropdown-toggle">Docs</a>
                                            <ul class="dropdown-menu glass-card">
                                                
                                                    <li class="">
                                                        <a href="../../installation/">Installation</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/getting_started/">Getting Started</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/async_vs_sync/">Async vs. Sync</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/connecting/">Connecting to Instruments</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/simulation/">Simulation Mode</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/bench_descriptors/">Bench Descriptors</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/errors/">Error Handling</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/uncertainty/">Handling Uncertainty</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../user_guide/cli/">Command-Line Interface</a>
                                                    </li>
                                                
                                            </ul>
                                        </li>
                                    
                                
                            
                                
                                    
                                        <li class="nav-item dropdown ">
                                            <a href="#" class="dropdown-toggle">Tutorials</a>
                                            <ul class="dropdown-menu glass-card">
                                                
                                                    <li class="">
                                                        <a href="../../../tutorials/10_minute_tour.ipynb">10 Minute Tour</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../../tutorials/compliance.ipynb">Compliance and Audit</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../../tutorials/custom_validations.ipynb">Custom Validations</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../../tutorials/profile_creation.ipynb">Profile Creation</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../../tutorials/smartbench.ipynb">SmartBench Example</a>
                                                    </li>
                                                
                                            </ul>
                                        </li>
                                    
                                
                            
                                
                                    
                                        <li class="nav-item dropdown active">
                                            <a href="#" class="dropdown-toggle">API</a>
                                            <ul class="dropdown-menu glass-card">
                                                
                                                    <li class="">
                                                        <a href="../instruments/">Instruments</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../measurements/">Measurements</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../experiments/">Experiments & Database</a>
                                                    </li>
                                                
                                                    <li class="active">
                                                        <a href="./">Backends</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../config/">Configuration</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../errors/">Errors</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../common/">Common Utilities</a>
                                                    </li>
                                                
                                            </ul>
                                        </li>
                                    
                                
                            
                                
                                    
                                        <li class="nav-item dropdown ">
                                            <a href="#" class="dropdown-toggle">Instruments</a>
                                            <ul class="dropdown-menu glass-card">
                                                
                                                    <li class="">
                                                        <a href="../../profiles/gallery/">Profile Gallery</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../profiles/creating/">Creating Profiles</a>
                                                    </li>
                                                
                                            </ul>
                                        </li>
                                    
                                
                            
                                
                                    
                                        <li class="nav-item dropdown ">
                                            <a href="#" class="dropdown-toggle">Community</a>
                                            <ul class="dropdown-menu glass-card">
                                                
                                                    <li class="">
                                                        <a href="../../contributing/">Contributing</a>
                                                    </li>
                                                
                                                    <li class="">
                                                        <a href="../../changelog/">Changelog</a>
                                                    </li>
                                                
                                            </ul>
                                        </li>
                                    
                                
                            
                        </ul>
                    </nav>

                    <div class="header-actions">
                        <!-- Search component -->
                        <div class="search-container">
                            <button class="search-button" id="searchButton" aria-label="Open Search">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>

                        <!-- Search Modal -->
                        <div class="search-modal" id="searchModal">
                            <div class="search-modal-content">
                                <form class="search-form">
                                    <input type="text" class="search-input" id="searchInput" placeholder="Search documentation..." autofocus>
                                    <button type="button" class="search-close" id="searchClose">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </form>
                                <div class="search-results">
                                    <div class="search-results-meta" id="searchResultsMeta">Type to start searching</div>
                                    <div id="searchResults"></div>
                                </div>
                            </div>
                        </div>

                        
                        <a href="https://github.com/pytestlab/pytestlab" target="_blank" class="beam-button beam-button-sm">
                            <span class="beam-button-text">GitHub</span>
                        </a>
                        
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="main-content">
            <div class="container">
                <div class="content-layout">
                    <!-- Sidebar / Table of Contents -->
                    
                    <aside class="sidebar">
                        <div class="glass-card toc-container">
                            <div class="toc-header">
                                <h4>Contents</h4>
                            </div>
                            
                                <ul class="toc">
                                    
                                        <li class="toc-item level-1">
                                            <a href="#instrument-backends">Instrument Backends</a>
                                            
                                                <ul>
                                                    
                                                        <li class="toc-item level-2">
                                                            <a href="#overview">Overview</a>
                                                        </li>
                                                    
                                                        <li class="toc-item level-2">
                                                            <a href="#available-backends">Available Backends</a>
                                                        </li>
                                                    
                                                        <li class="toc-item level-2">
                                                            <a href="#pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend">AsyncVisaBackend</a>
                                                        </li>
                                                    
                                                        <li class="toc-item level-2">
                                                            <a href="#pytestlab.instruments.backends.lamb.AsyncLambBackend">AsyncLambBackend</a>
                                                        </li>
                                                    
                                                        <li class="toc-item level-2">
                                                            <a href="#pytestlab.instruments.backends.sim_backend_v2.SimBackendV2">SimBackendV2</a>
                                                        </li>
                                                    
                                                        <li class="toc-item level-2">
                                                            <a href="#pytestlab.instruments.backends.recording_backend.RecordingBackend">RecordingBackend</a>
                                                        </li>
                                                    
                                                        <li class="toc-item level-2">
                                                            <a href="#backend-selection-logic">Backend Selection Logic</a>
                                                        </li>
                                                    
                                                        <li class="toc-item level-2">
                                                            <a href="#extending-backends">Extending Backends</a>
                                                        </li>
                                                    
                                                </ul>
                                            
                                        </li>
                                    
                                </ul>
                            
                        </div>
                    </aside>
                    

                    <!-- Main Content Area -->
                    <div class="page-content glass-card">
                        <div class="article">
                            
                            <h1 class="page-title">Backends</h1>
                            
                            

                            
                                <h1 id="instrument-backends">Instrument Backends</h1>
<p>PyTestLab supports multiple instrument communication backends, each designed for a specific class of hardware or simulation use case. This page documents the main backend classes and their roles.</p>
<hr />
<h2 id="overview">Overview</h2>
<p>A <strong>backend</strong> is the low-level driver responsible for communicating with an instrument. Backends abstract the transport mechanism (VISA, Lamb, simulation, etc.) so that high-level instrument drivers can use a unified API.</p>
<p>Backends are typically not used directly by end-users. Instead, they are selected automatically based on your instrument profile, connection string, and simulation settings.</p>
<hr />
<h2 id="available-backends">Available Backends</h2>
<h3 id="asyncvisabackend"><code>AsyncVisaBackend</code></h3>
<p>Asynchronous backend for VISA-compatible instruments (e.g., GPIB, USB, TCPIP, RS232). Uses <a href="https://pyvisa.readthedocs.io/">PyVISA</a> under the hood.</p>


<div class="doc doc-object doc-class">



<h2 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend" class="doc doc-heading">
              <code class="highlight language-python">pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend(address, timeout_ms=5000)</code>

</h2>


    <div class="doc doc-contents first">


        <p>An asynchronous backend for communicating with instruments using pyvisa,
by running blocking calls in a separate thread via anyio.
This class implements the AsyncInstrumentIO protocol.</p>







                  <details class="quote">
                    <summary>Source code in <code>pytestlab/instruments/backends/async_visa_backend.py</code></summary>
                    <pre class="highlight"><code class="language-python">def __init__(self, address: str, timeout_ms: Optional[int] = 5000):
    self.address = address
    self.rm = pyvisa.ResourceManager()
    self.instrument: Optional[MessageBasedResource] = None
    self._timeout_ms = timeout_ms if timeout_ms is not None else 5000 # Default to 5 seconds
    self._lock = anyio.Lock() # For thread-safety around instrument access</code></pre>
                  </details>



  <div class="doc doc-children">





<h3 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend-attributes">Attributes</h3>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend.address" class="doc doc-heading">
            <code class="highlight language-python">address = address</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend.instrument" class="doc doc-heading">
            <code class="highlight language-python">instrument = None</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend.rm" class="doc doc-heading">
            <code class="highlight language-python">rm = pyvisa.ResourceManager()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<h3 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend-functions">Functions</h3>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend.close" class="doc doc-heading">
            <code class="highlight language-python">close()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Closes the connection asynchronously (alias for disconnect).</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/async_visa_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">async def close(self) -&gt; None:
    """Closes the connection asynchronously (alias for disconnect)."""
    await self.disconnect()</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend.connect" class="doc doc-heading">
            <code class="highlight language-python">connect()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Connects to the VISA resource asynchronously.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/async_visa_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">async def connect(self) -&gt; None:
    """Connects to the VISA resource asynchronously."""
    async with self._lock:
        if self.instrument is not None:
            try:
                # Ensure existing instrument is closed before reconnecting
                await anyio.to_thread.run_sync(self.instrument.close)
            except Exception:
                # Ignore errors if already closed or in a bad state
                pass
            self.instrument = None

        try:
            # Run the blocking open_resource call in a thread
            resource = await anyio.to_thread.run_sync(self.rm.open_resource, self.address)
            if not isinstance(resource, pyvisa.resources.MessageBasedResource):
                raise InstrumentConnectionError(
                    f"Resource at {self.address} is not a MessageBasedResource. Type: {type(resource).__name__}"
                )
            self.instrument = cast('MessageBasedResource', resource) # Cast for type checker

            # Set timeout on the instrument object
            def _set_timeout_on_instrument(instr: MessageBasedResource, timeout: int) -&gt; None:
                instr.timeout = timeout
            await anyio.to_thread.run_sync(_set_timeout_on_instrument, self.instrument, self._timeout_ms)

        except pyvisa.Error as e:
            raise InstrumentConnectionError(f"Failed to connect to VISA resource {self.address}: {e}") from e
        except Exception as e:
            raise InstrumentConnectionError(f"An unexpected error occurred while connecting to VISA resource {self.address}: {e}") from e</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend.disconnect" class="doc doc-heading">
            <code class="highlight language-python">disconnect()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Disconnects from the VISA resource asynchronously.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/async_visa_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">async def disconnect(self) -&gt; None:
    """Disconnects from the VISA resource asynchronously."""
    async with self._lock:
        if self.instrument is not None:
            try:
                await anyio.to_thread.run_sync(self.instrument.close)
            except pyvisa.Error as e:
                raise InstrumentConnectionError(f"Error disconnecting from VISA resource {self.address}: {e}") from e
            except Exception as e:
                raise InstrumentConnectionError(f"An unexpected error occurred while disconnecting VISA resource {self.address}: {e}") from e
            finally:
                self.instrument = None</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend.get_timeout" class="doc doc-heading">
            <code class="highlight language-python">get_timeout()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Gets the communication timeout in milliseconds.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/async_visa_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">async def get_timeout(self) -&gt; int:
    """Gets the communication timeout in milliseconds."""
    # Return the locally stored timeout. Reading from instrument is not always reliable
    # and the local value is the intended setting.
    return self._timeout_ms</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend.query" class="doc doc-heading">
            <code class="highlight language-python">query(cmd, delay=None)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Sends a query and returns the string response asynchronously.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/async_visa_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">async def query(self, cmd: str, delay: Optional[float] = None) -&gt; str:
    """Sends a query and returns the string response asynchronously."""
    if self.instrument is None:
        raise InstrumentConnectionError("Not connected to VISA resource. Call connect() first.")

    instr = self.instrument # Local reference
    def _blocking_query(command: str, q_delay: Optional[float]) -&gt; str:
        return instr.query(command, delay=q_delay).strip()

    async with self._lock:
        if self.instrument is None:
             raise InstrumentConnectionError("Instrument became disconnected before query.")
        try:
            response = await anyio.to_thread.run_sync(_blocking_query, cmd, delay)
            return response
        except pyvisa.Error as e:
            raise InstrumentCommunicationError(f"Failed to query '{cmd}' from {self.address}: {e}") from e
        except Exception as e:
            raise InstrumentCommunicationError(f"An unexpected error occurred querying '{cmd}' from {self.address}: {e}") from e</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend.query_raw" class="doc doc-heading">
            <code class="highlight language-python">query_raw(cmd, delay=None)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Sends a query and returns the raw bytes response asynchronously.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/async_visa_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">async def query_raw(self, cmd: str, delay: Optional[float] = None) -&gt; bytes:
    """Sends a query and returns the raw bytes response asynchronously."""
    if self.instrument is None:
        raise InstrumentConnectionError("Not connected to VISA resource. Call connect() first.")

    instr = self.instrument # Local reference
    def _blocking_query_raw(command: str, q_delay: Optional[float]) -&gt; bytes:
        instr.write(command) # Write the command
        if q_delay is not None:
            time.sleep(q_delay) # Blocking sleep in the thread
        # Assuming read_bytes is the appropriate method for raw data.
        # Adjust chunk_size or method (e.g. read_raw()) as needed.
        return instr.read_bytes(instr.chunk_size) 

    async with self._lock:
        if self.instrument is None:
             raise InstrumentConnectionError("Instrument became disconnected before query_raw.")
        try:
            data = await anyio.to_thread.run_sync(_blocking_query_raw, cmd, delay)
            return data
        except pyvisa.Error as e:
            raise InstrumentCommunicationError(f"Failed to query_raw '{cmd}' from {self.address}: {e}") from e
        except Exception as e:
            raise InstrumentCommunicationError(f"An unexpected error occurred during query_raw '{cmd}' from {self.address}: {e}") from e</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend.set_timeout" class="doc doc-heading">
            <code class="highlight language-python">set_timeout(timeout_ms)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Sets the communication timeout in milliseconds asynchronously.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/async_visa_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">async def set_timeout(self, timeout_ms: int) -&gt; None:
    """Sets the communication timeout in milliseconds asynchronously."""
    if timeout_ms &lt;= 0:
        raise ValueError("Timeout must be positive.")

    self._timeout_ms = timeout_ms # Update local store immediately

    if self.instrument:
        instr = self.instrument # Local reference
        def _blocking_set_timeout(timeout_val: int) -&gt; None:
            instr.timeout = timeout_val

        async with self._lock: # Ensure instrument object isn't changed during this
            if self.instrument: # Re-check after lock
                try:
                    await anyio.to_thread.run_sync(_blocking_set_timeout, timeout_ms)
                except pyvisa.Error as e:
                    # Log this, but don't necessarily fail the operation.
                    print(f"Warning: Could not set timeout on async VISA resource {self.address}: {e}")
                except Exception as e:
                    print(f"Warning: An unexpected error occurred setting timeout on async VISA resource {self.address}: {e}")</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.async_visa_backend.AsyncVisaBackend.write" class="doc doc-heading">
            <code class="highlight language-python">write(cmd)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Writes a command to the instrument asynchronously.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/async_visa_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">async def write(self, cmd: str) -&gt; None:
    """Writes a command to the instrument asynchronously."""
    if self.instrument is None:
        raise InstrumentConnectionError("Not connected to VISA resource. Call connect() first.")

    instr = self.instrument # Local reference for thread safety
    def _blocking_write(command: str) -&gt; None:
        instr.write(command)

    async with self._lock: # Ensure exclusive access for the write operation
        if self.instrument is None: # Re-check after acquiring lock
             raise InstrumentConnectionError("Instrument became disconnected before write.")
        try:
            await anyio.to_thread.run_sync(_blocking_write, cmd)
        except pyvisa.Error as e:
            raise InstrumentCommunicationError(f"Failed to write command '{cmd}' to {self.address}: {e}") from e
        except Exception as e:
            raise InstrumentCommunicationError(f"An unexpected error occurred writing command '{cmd}' to {self.address}: {e}") from e</code></pre>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h3 id="asynclambbackend"><code>AsyncLambBackend</code></h3>
<p>Backend for instruments accessible via the <a href="https://github.com/e-a-olowe/lamb">Lamb</a> remote instrument server protocol. Supports async TCP communication with Lamb daemons.</p>


<div class="doc doc-object doc-class">



<h2 id="pytestlab.instruments.backends.lamb.AsyncLambBackend" class="doc doc-heading">
              <code class="highlight language-python">pytestlab.instruments.backends.lamb.AsyncLambBackend(address=None, url='http://lamb-server:8000', timeout_ms=10000, model_name=None, serial_number=None)</code>

</h2>


    <div class="doc doc-contents first">


        <p>An asynchronous backend for communicating with instruments via a Lamb server.
Supports both direct visa_string and auto-connect via model/serial_number.</p>



<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>address</code>
            </td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>The visa_string or unique instrument address. If not provided, model_name and serial_number must be provided.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>url</code>
            </td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Lamb server base URL.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><span title="str">str</span></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>&#39;http://lamb-server:8000&#39;</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timeout_ms</code>
            </td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Communication timeout in ms.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>10000</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Model name for auto-connect.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>serial_number</code>
            </td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Serial number for auto-connect.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>







                  <details class="quote">
                    <summary>Source code in <code>pytestlab/instruments/backends/lamb.py</code></summary>
                    <pre class="highlight"><code class="language-python">def __init__(
    self,
    address: Optional[str] = None,
    url: str = "http://lamb-server:8000",
    timeout_ms: Optional[int] = 10000,
    model_name: Optional[str] = None,
    serial_number: Optional[str] = None,
):
    """
    Args:
        address: The visa_string or unique instrument address. If not provided, model_name and serial_number must be provided.
        url: Lamb server base URL.
        timeout_ms: Communication timeout in ms.
        model_name: Model name for auto-connect.
        serial_number: Serial number for auto-connect.
    """
    self.base_url: str = url.rstrip('/')
    self.instrument_address: Optional[str] = address  # visa_string
    self.model_name: Optional[str] = model_name
    self.serial_number: Optional[str] = serial_number
    self._timeout_sec: float = (timeout_ms / 1000.0) if timeout_ms and timeout_ms &gt; 0 else 5.0
    self._client: Optional[httpx.AsyncClient] = None
    self._auto_connect_performed: bool = False

    lamb_logger.info(
        f"AsyncLambBackend initialized for address='{address}', model='{model_name}', serial='{serial_number}' at URL '{url}'"
    )</code></pre>
                  </details>



  <div class="doc doc-children">





<h3 id="pytestlab.instruments.backends.lamb.AsyncLambBackend-attributes">Attributes</h3>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.lamb.AsyncLambBackend.base_url" class="doc doc-heading">
            <code class="highlight language-python">base_url = url.rstrip('/')</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.lamb.AsyncLambBackend.instrument_address" class="doc doc-heading">
            <code class="highlight language-python">instrument_address = address</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.lamb.AsyncLambBackend.model_name" class="doc doc-heading">
            <code class="highlight language-python">model_name = model_name</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.lamb.AsyncLambBackend.serial_number" class="doc doc-heading">
            <code class="highlight language-python">serial_number = serial_number</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<h3 id="pytestlab.instruments.backends.lamb.AsyncLambBackend-functions">Functions</h3>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.lamb.AsyncLambBackend.close" class="doc doc-heading">
            <code class="highlight language-python">close()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/lamb.py</code></summary>
              <pre class="highlight"><code class="language-python">async def close(self) -&gt; None:
    await self.disconnect()</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.lamb.AsyncLambBackend.connect" class="doc doc-heading">
            <code class="highlight language-python">connect()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Ensures the instrument is registered with Lamb and ready.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/lamb.py</code></summary>
              <pre class="highlight"><code class="language-python">async def connect(self) -&gt; None:
    """
    Ensures the instrument is registered with Lamb and ready.
    """
    await self._ensure_connected()
    # Optionally, ping instrument status endpoint here
    lamb_logger.info(f"Connected to Lamb instrument '{self.instrument_address}'.")</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.lamb.AsyncLambBackend.disconnect" class="doc doc-heading">
            <code class="highlight language-python">disconnect()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/lamb.py</code></summary>
              <pre class="highlight"><code class="language-python">async def disconnect(self) -&gt; None:
    lamb_logger.info(f"AsyncLambBackend for '{self.instrument_address}' disconnected (simulated, as client is per-request or context-managed).")
    pass</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.lamb.AsyncLambBackend.get_timeout" class="doc doc-heading">
            <code class="highlight language-python">get_timeout()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/lamb.py</code></summary>
              <pre class="highlight"><code class="language-python">async def get_timeout(self) -&gt; int:
    return int(self._timeout_sec * 1000)</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.lamb.AsyncLambBackend.query" class="doc doc-heading">
            <code class="highlight language-python">query(cmd, delay=None)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/lamb.py</code></summary>
              <pre class="highlight"><code class="language-python">async def query(self, cmd: str, delay: Optional[float] = None) -&gt; str:
    await self._ensure_connected()
    lamb_logger.debug(f"QUERY to '{self.instrument_address}': {cmd}")
    try:
        async with httpx.AsyncClient(timeout=self._timeout_sec) as client:
            response = await client.post(
                f"{self.base_url}/instrument/query",
                json={"visa_string": self.instrument_address, "command": cmd},
                headers={"Accept": "application/json", 'Accept-Charset': 'utf-8'}
            )
            response.raise_for_status()
            content: str = response.content.decode('utf-8')
            return content.strip()
    except httpx.HTTPStatusError as e:
        raise InstrumentCommunicationError(
            f"Lamb server query failed: {e.response.status_code} - {e.response.text}"
        ) from e
    except httpx.RequestError as e:
        raise InstrumentCommunicationError(
            f"Network error during Lamb query: {e}"
        ) from e</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.lamb.AsyncLambBackend.query_raw" class="doc doc-heading">
            <code class="highlight language-python">query_raw(cmd, delay=None)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/lamb.py</code></summary>
              <pre class="highlight"><code class="language-python">async def query_raw(self, cmd: str, delay: Optional[float] = None) -&gt; bytes:
    await self._ensure_connected()
    lamb_logger.debug(f"QUERY_RAW to '{self.instrument_address}': {cmd}")
    try:
        async with httpx.AsyncClient(timeout=self._timeout_sec) as client:
            response = await client.post(
                f"{self.base_url}/instrument/query_raw",
                json={"visa_string": self.instrument_address, "command": cmd},
                headers={"Accept": "application/octet-stream"}
            )
            response.raise_for_status()
            return response.content
    except httpx.HTTPStatusError as e:
        raise InstrumentCommunicationError(
            f"Lamb server query_raw failed: {e.response.status_code} - {e.response.text}"
        ) from e
    except httpx.RequestError as e:
        raise InstrumentCommunicationError(
            f"Network error during Lamb query_raw: {e}"
        ) from e</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.lamb.AsyncLambBackend.set_timeout" class="doc doc-heading">
            <code class="highlight language-python">set_timeout(timeout_ms)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/lamb.py</code></summary>
              <pre class="highlight"><code class="language-python">async def set_timeout(self, timeout_ms: int) -&gt; None:
    if timeout_ms &lt;= 0:
        self._timeout_sec = 0.001
    else:
        self._timeout_sec = timeout_ms / 1000.0
    lamb_logger.debug(f"AsyncLambBackend timeout set to {self._timeout_sec} seconds.")</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.lamb.AsyncLambBackend.write" class="doc doc-heading">
            <code class="highlight language-python">write(cmd)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/lamb.py</code></summary>
              <pre class="highlight"><code class="language-python">async def write(self, cmd: str) -&gt; None:
    await self._ensure_connected()
    lamb_logger.debug(f"WRITE to '{self.instrument_address}': {cmd}")
    try:
        async with httpx.AsyncClient(timeout=self._timeout_sec) as client:
            response = await client.post(
                f"{self.base_url}/instrument/write",
                json={"visa_string": self.instrument_address, "command": cmd},
                headers={"Accept": "application/json", 'Accept-Charset': 'utf-8'}
            )
            response.raise_for_status()
    except httpx.HTTPStatusError as e:
        raise InstrumentCommunicationError(
            f"Lamb server write failed: {e.response.status_code} - {e.response.text}"
        ) from e
    except httpx.RequestError as e:
        raise InstrumentCommunicationError(
            f"Network error during Lamb write: {e}"
        ) from e</code></pre>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h3 id="simbackendv2"><code>SimBackendV2</code></h3>
<p>YAML-driven simulation backend. Provides deterministic, profile-based simulation for development, CI, and testing. Reads the <code>simulation</code> section of instrument profiles.</p>


<div class="doc doc-object doc-class">



<h2 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2" class="doc doc-heading">
              <code class="highlight language-python">pytestlab.instruments.backends.sim_backend_v2.SimBackendV2(profile_path, *, model=None, timeout_ms=None)</code>

</h2>


    <div class="doc doc-contents first">


        <p>Drop-in replacement for the existing <em>SimBackend</em> with vastly richer
functionality (see module docstring for highlights).</p>







                  <details class="quote">
                    <summary>Source code in <code>pytestlab/instruments/backends/sim_backend_v2.py</code></summary>
                    <pre class="highlight"><code class="language-python">def __init__(
    self,
    profile_path: str | os.PathLike,
    *,
    model: str | None = None,
    timeout_ms: int | None = None,
) -&gt; None:
    self.profile_path = Path(profile_path)
    self.timeout_ms = timeout_ms or self.DEFAULT_TIMEOUT_MS
    self.model = model or self.profile_path.stem
    # main data
    self._profile = self._load_profile()
    self._state: dotdict = dotdict(self._profile["simulation"].get("initial_state", {}))
    self._error_queue: List[Tuple[int, str]] = []
    # dispatcher
    self._exact_map: Dict[str, Any] = {}
    self._pattern_rules: List[_PatternRule] = []
    self._build_dispatch_tables()
    logger.info("SimBackendV2 initialised for %s", self.model)</code></pre>
                  </details>



  <div class="doc doc-children">





<h3 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2-attributes">Attributes</h3>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2.DEFAULT_TIMEOUT_MS" class="doc doc-heading">
            <code class="highlight language-python">DEFAULT_TIMEOUT_MS = 5000</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2.USER_OVERRIDE_ROOT" class="doc doc-heading">
            <code class="highlight language-python">USER_OVERRIDE_ROOT = Path.home() / '.pytestlab' / 'sim_profiles'</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2.model" class="doc doc-heading">
            <code class="highlight language-python">model = model or self.profile_path.stem</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2.profile_path" class="doc doc-heading">
            <code class="highlight language-python">profile_path = Path(profile_path)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2.timeout_ms" class="doc doc-heading">
            <code class="highlight language-python">timeout_ms = timeout_ms or self.DEFAULT_TIMEOUT_MS</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<h3 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2-functions">Functions</h3>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2.close" class="doc doc-heading">
            <code class="highlight language-python">close()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/sim_backend_v2.py</code></summary>
              <pre class="highlight"><code class="language-python">async def close(self) -&gt; None:
    await self.disconnect()</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2.connect" class="doc doc-heading">
            <code class="highlight language-python">connect()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Establish connection (no-op in simulation).</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/sim_backend_v2.py</code></summary>
              <pre class="highlight"><code class="language-python">async def connect(self) -&gt; None:  # noqa: D401
    "Establish connection (no-op in simulation)."
    logger.debug("%s: connect()", self.model)</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2.disconnect" class="doc doc-heading">
            <code class="highlight language-python">disconnect()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Close connection (no-op).</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/sim_backend_v2.py</code></summary>
              <pre class="highlight"><code class="language-python">async def disconnect(self) -&gt; None:
    "Close connection (no-op)."
    logger.debug("%s: disconnect()", self.model)</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2.get_timeout" class="doc doc-heading">
            <code class="highlight language-python">get_timeout()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/sim_backend_v2.py</code></summary>
              <pre class="highlight"><code class="language-python">async def get_timeout(self) -&gt; int:
    return self.timeout_ms</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2.query" class="doc doc-heading">
            <code class="highlight language-python">query(cmd, delay=None)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Handle a SCPI query and return a <strong>decoded</strong> string.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/sim_backend_v2.py</code></summary>
              <pre class="highlight"><code class="language-python">async def query(self, cmd: str, delay: float | None = None) -&gt; str:
    "Handle a SCPI query and return a **decoded** string."
    if delay:
        await asyncio.sleep(delay)
    response = self._handle_command(cmd, expect_response=True)
    logger.debug("%s QUERY ‹%s› → %s", self.model, cmd.strip(), response)
    return response</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2.query_raw" class="doc doc-heading">
            <code class="highlight language-python">query_raw(cmd, delay=None)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/sim_backend_v2.py</code></summary>
              <pre class="highlight"><code class="language-python">async def query_raw(self, cmd: str, delay: float | None = None) -&gt; bytes:
    resp = await self.query(cmd, delay)
    if isinstance(resp, bytes):
        return resp
    return resp.encode()</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2.set_timeout" class="doc doc-heading">
            <code class="highlight language-python">set_timeout(timeout_ms)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/sim_backend_v2.py</code></summary>
              <pre class="highlight"><code class="language-python">async def set_timeout(self, timeout_ms: int) -&gt; None:
    self.timeout_ms = timeout_ms</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.sim_backend_v2.SimBackendV2.write" class="doc doc-heading">
            <code class="highlight language-python">write(cmd)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Handle a SCPI write.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/sim_backend_v2.py</code></summary>
              <pre class="highlight"><code class="language-python">async def write(self, cmd: str) -&gt; None:
    "Handle a SCPI write."
    logger.debug("%s WRITE ‹%s›", self.model, cmd.strip())
    self._handle_command(cmd)</code></pre>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h3 id="recordingbackend"><code>RecordingBackend</code></h3>
<p>A backend that wraps another backend and records all SCPI commands and responses. Used for generating simulation profiles and debugging.</p>


<div class="doc doc-object doc-class">



<h2 id="pytestlab.instruments.backends.recording_backend.RecordingBackend" class="doc doc-heading">
              <code class="highlight language-python">pytestlab.instruments.backends.recording_backend.RecordingBackend(backend, output_path=None, base_profile=None)</code>

</h2>


    <div class="doc doc-contents first">


        <p>A backend that records interactions to a simulation profile.</p>







                  <details class="quote">
                    <summary>Source code in <code>pytestlab/instruments/backends/recording_backend.py</code></summary>
                    <pre class="highlight"><code class="language-python">def __init__(self, backend, output_path=None, base_profile=None):
    self.backend = backend
    self.output_path = output_path
    self.base_profile = base_profile if base_profile is not None else {}
    self.log = []
    self.start_time = time.monotonic()</code></pre>
                  </details>



  <div class="doc doc-children">





<h3 id="pytestlab.instruments.backends.recording_backend.RecordingBackend-attributes">Attributes</h3>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.recording_backend.RecordingBackend.backend" class="doc doc-heading">
            <code class="highlight language-python">backend = backend</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.recording_backend.RecordingBackend.base_profile" class="doc doc-heading">
            <code class="highlight language-python">base_profile = base_profile if base_profile is not None else {}</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.recording_backend.RecordingBackend.log" class="doc doc-heading">
            <code class="highlight language-python">log = []</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.recording_backend.RecordingBackend.output_path" class="doc doc-heading">
            <code class="highlight language-python">output_path = output_path</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="pytestlab.instruments.backends.recording_backend.RecordingBackend.start_time" class="doc doc-heading">
            <code class="highlight language-python">start_time = time.monotonic()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

    </div>

</div>

<h3 id="pytestlab.instruments.backends.recording_backend.RecordingBackend-functions">Functions</h3>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.recording_backend.RecordingBackend.__getattr__" class="doc doc-heading">
            <code class="highlight language-python">__getattr__(name)</code>

</h4>


    <div class="doc doc-contents ">

        <p>Delegate other attributes to the wrapped backend.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/recording_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">def __getattr__(self, name):
    """Delegate other attributes to the wrapped backend."""
    return getattr(self.backend, name)</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.recording_backend.RecordingBackend.close" class="doc doc-heading">
            <code class="highlight language-python">close()</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Close the backend and write the simulation profile.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/recording_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">async def close(self):
    """Close the backend and write the simulation profile."""
    if hasattr(self.backend, 'close') and callable(getattr(self.backend, 'close')):
        result = self.backend.close()
        if asyncio.iscoroutine(result):
            await result
    print("DEBUG: Calling generate_profile from RecordingBackend.close()")
    self.generate_profile()</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.recording_backend.RecordingBackend.generate_profile" class="doc doc-heading">
            <code class="highlight language-python">generate_profile()</code>

</h4>


    <div class="doc doc-contents ">

        <p>Generate the YAML simulation profile from the log.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/recording_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">def generate_profile(self):
    """Generate the YAML simulation profile from the log."""
    print(f"DEBUG: generate_profile called. Output path: {self.output_path}")
    scpi_map = {}
    for entry in self.log:
        if entry["type"] == "query":
            scpi_map[entry["command"]] = entry["response"]
        elif entry["type"] == "query_raw":
            command_slug = re.sub(r"[^a-zA-Z0-9]", "_", entry["command"])
            binary_filename = f"{command_slug}.bin"
            binary_filepath = Path(self.output_path).parent / binary_filename
            with open(binary_filepath, "wb") as f:
                f.write(entry["response"])
            scpi_map[entry["command"]] = {"binary": binary_filename}
        elif entry["type"] == "write":
            # For writes, we record the command with an empty response,
            # which is suitable for commands that don't return a value.
            scpi_map[entry["command"]] = ""

    profile = self.base_profile
    if "simulation" not in profile:
        profile["simulation"] = {}
    profile["simulation"]["scpi"] = scpi_map
    print(f"DEBUG: Profile data to be written: {profile}")
    if self.output_path:
        try:
            output_file = Path(self.output_path)
            print(f"DEBUG: Creating parent directory for {output_file}")
            output_file.parent.mkdir(parents=True, exist_ok=True)
            print(f"DEBUG: Writing to file {output_file}")
            with open(output_file, "w") as f:
                yaml.dump(profile, f, sort_keys=False)
            print("DEBUG: File write complete.")
            LOGGER.info(f"Simulation profile saved to {self.output_path}")
        except Exception as e:
            print(f"DEBUG: ERROR in generate_profile: {e}")
    else:
        # In a real scenario, this would go to a user cache directory.
        # For now, let's just print it if no path is provided.
        print("DEBUG: No output path provided. Printing to stdout.")
        print(yaml.dump(profile, sort_keys=False))</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.recording_backend.RecordingBackend.query" class="doc doc-heading">
            <code class="highlight language-python">query(command, *args, **kwargs)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Async query to the instrument, log it, and return the response.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/recording_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">async def query(self, command: str, *args, **kwargs):
    """Async query to the instrument, log it, and return the response."""
    if hasattr(self.backend, 'query') and callable(getattr(self.backend, 'query')):
        result = self.backend.query(command, *args, **kwargs)
        if asyncio.iscoroutine(result):
            response = await result
        else:
            response = result
        self.log.append({
            "type": "query",
            "command": command.strip(),
            "response": getattr(response, 'strip', lambda: response)()
        })
        return response
    raise NotImplementedError("Backend does not support query method.")</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.recording_backend.RecordingBackend.query_raw" class="doc doc-heading">
            <code class="highlight language-python">query_raw(command, *args, **kwargs)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Async query to the instrument, log it, and return the response.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/recording_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">async def query_raw(self, command: str, *args, **kwargs):
    """Async query to the instrument, log it, and return the response."""
    if hasattr(self.backend, 'query_raw') and callable(getattr(self.backend, 'query_raw')):
        result = self.backend.query_raw(command, *args, **kwargs)
        if asyncio.iscoroutine(result):
            response = await result
        else:
            response = result
        self.log.append({
            "type": "query_raw",
            "command": command.strip(),
            "response": response
        })
        return response
    raise NotImplementedError("Backend does not support query_raw method.")</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.recording_backend.RecordingBackend.read" class="doc doc-heading">
            <code class="highlight language-python">read()</code>

</h4>


    <div class="doc doc-contents ">

        <p>Read from the instrument and log it.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/recording_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">def read(self) -&gt; str:
    """Read from the instrument and log it."""
    response = self.backend.read()
    self.log.append({"type": "read", "response": response.strip()})
    return response</code></pre>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="pytestlab.instruments.backends.recording_backend.RecordingBackend.write" class="doc doc-heading">
            <code class="highlight language-python">write(command, *args, **kwargs)</code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Async write a command to the instrument and log it.</p>


            <details class="quote">
              <summary>Source code in <code>pytestlab/instruments/backends/recording_backend.py</code></summary>
              <pre class="highlight"><code class="language-python">async def write(self, command: str, *args, **kwargs):
    """Async write a command to the instrument and log it."""
    self.log.append({"type": "write", "command": command.strip()})
    if hasattr(self.backend, 'write') and callable(getattr(self.backend, 'write')):
        result = self.backend.write(command, *args, **kwargs)
        if asyncio.iscoroutine(result):
            return await result
        return result
    raise NotImplementedError("Backend does not support write method.")</code></pre>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="backend-selection-logic">Backend Selection Logic</h2>
<p>PyTestLab chooses the backend automatically based on:</p>
<ul>
<li>The <code>simulate</code> flag (in code or <code>bench.yaml</code>)</li>
<li>The instrument's <code>address</code> (e.g., <code>"sim"</code> triggers simulation)</li>
<li>The <code>backend</code> or <code>backend_defaults</code> fields in your configuration</li>
</ul>
<p>You can override backend selection by specifying <code>backend_type_hint</code> when creating an instrument.</p>
<hr />
<h2 id="extending-backends">Extending Backends</h2>
<p>To add support for a new hardware interface, subclass <code>InstrumentBackendBase</code> and implement the required async methods (<code>open</code>, <code>close</code>, <code>write</code>, <code>query</code>, etc.). See the source code and existing backends for examples.</p>
<hr />
<p>For more details on simulation, see the <a href="../../user_guide/simulation/">Simulation Guide</a>.</p>
                            
                        </div>

                        <!-- Page Navigation (Previous/Next) -->
                        
                        <div class="page-nav">
                            
                                <a href="../experiments/" class="prev-link">
                                    <span class="nav-label">Previous</span>
                                    <span class="nav-title">Experiments & Database</span>
                                </a>
                            

                            
                                <a href="../config/" class="next-link">
                                    <span class="nav-label">Next</span>
                                    <span class="nav-title">Configuration</span>
                                </a>
                            
                        </div>
                        
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="site-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-copyright">
                        <p>&copy; 2025 LABIIUM. All rights reserved.</p>
                        <p>PyTestLab is an open-source project.</p>
                    </div>

                    <div class="footer-links">
                        
                            <a href="https://github.com/pytestlab/pytestlab" target="_blank">GitHub</a>
                        
                        
                        <a href="../../changelog/">Changelog</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- JavaScript -->
    <script src="../../js/theme.js"></script>

    <!-- Search and Enhanced functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Search Modal ---
            const searchButton = document.getElementById('searchButton');
            const searchModal = document.getElementById('searchModal');
            const searchClose = document.getElementById('searchClose');
            const searchInput = document.getElementById('searchInput');
            let searchIndex = null;

            // Load search index with better path resolution
            const searchPath = window.location.pathname.includes('/site/')
                ? '../search/search_index.json'
                : 'search/search_index.json';

            fetch(searchPath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Search index not found');
                    }
                    return response.json();
                })
                .then(data => {
                    searchIndex = data;
                    console.log('Search index loaded successfully');
                })
                .catch((error) => {
                    console.log('Search index not found, trying alternative paths');
                    // Try alternative paths
                    const altPaths = ['../search/search_index.json', './search/search_index.json', '/search/search_index.json'];

                    altPaths.reduce((promise, path) => {
                        return promise.catch(() => {
                            return fetch(path).then(response => {
                                if (!response.ok) throw new Error('Not found');
                                return response.json();
                            }).then(data => {
                                searchIndex = data;
                                console.log('Search index loaded from:', path);
                            });
                        });
                    }, Promise.reject()).catch(() => {
                        console.log('Search functionality disabled - no search index found');
                    });
                });

            if (searchButton && searchModal && searchClose) {
                searchButton.addEventListener('click', function() {
                    searchModal.classList.add('active');
                    setTimeout(() => {
                        searchInput.focus();
                    }, 100);
                });

                searchClose.addEventListener('click', function() {
                    searchModal.classList.remove('active');
                });

                // Close on escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && searchModal.classList.contains('active')) {
                        searchModal.classList.remove('active');
                    }
                });
            }

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.trim().toLowerCase();
                    const searchResultsMeta = document.getElementById('searchResultsMeta');
                    const searchResults = document.getElementById('searchResults');

                    if (query.length > 1) {
                        searchResultsMeta.textContent = 'Searching...';
                        searchResults.innerHTML = '';

                        if (searchIndex) {
                            const results = performSearch(query, searchIndex);
                            displaySearchResults(results, searchResultsMeta, searchResults);
                        } else {
                            searchResultsMeta.textContent = 'Loading search index...';
                            searchResults.innerHTML = '<div class="search-result-item"><p style="color: var(--lab-aqua); padding: 1rem;">Search index is loading. If this persists, make sure the site has been built with <code>mkdocs build</code>.</p></div>';
                        }
                    } else {
                        searchResultsMeta.textContent = 'Type to start searching';
                        searchResults.innerHTML = '';
                    }
                });
            }

            function performSearch(query, index) {
                const results = [];
                // Handle different search index formats
                const docs = index.docs || index.articles || [];

                docs.forEach((doc, i) => {
                    const title = (doc.title || '').toLowerCase();
                    const text = (doc.text || doc.content || '').toLowerCase();
                    const location = doc.location || doc.url || '#';

                    if (title.includes(query) || text.includes(query)) {
                        const titleIndex = title.indexOf(query);
                        const textIndex = text.indexOf(query);
                        const score = (titleIndex >= 0 ? 10 : 0) + (textIndex >= 0 ? 1 : 0);

                        results.push({
                            title: doc.title || 'Untitled',
                            location: location,
                            text: text || 'No description available',
                            score: score
                        });
                    }
                });

                return results.sort((a, b) => b.score - a.score).slice(0, 10);
            }

            function displaySearchResults(results, metaElement, resultsElement) {
                if (results.length > 0) {
                    metaElement.textContent = `${results.length} result${results.length > 1 ? 's' : ''} found`;

                    resultsElement.innerHTML = results.map(result => `
                        <div class="search-result-item">
                            <a href="${result.location}" class="search-result-link">
                                <div class="search-result-title">${result.title}</div>
                                <div class="search-result-text">${result.text.substring(0, 150)}...</div>
                            </a>
                        </div>
                    `).join('');
                } else {
                    metaElement.textContent = 'No results found';
                    resultsElement.innerHTML = '';
                }
            }

            // --- Enhanced Code Block Copy functionality ---
            const codeBlocks = document.querySelectorAll('pre');
            codeBlocks.forEach(block => {
                // Add copy button
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>Copy';
                copyButton.setAttribute('aria-label', 'Copy code to clipboard');

                copyButton.addEventListener('click', () => {
                    const code = block.querySelector('code')?.textContent || block.textContent;

                    navigator.clipboard.writeText(code).then(() => {
                        copyButton.classList.add('copied');
                        copyButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg>Copied!';

                        setTimeout(() => {
                            copyButton.classList.remove('copied');
                            copyButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>Copy';
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                    });
                });

                block.appendChild(copyButton);

                // Add language indicator
                const language = block.querySelector('code')?.className.match(/language-(\w+)/)?.[1];
                if (language) {
                    const langBadge = document.createElement('div');
                    langBadge.className = 'lang-badge';

                    // Format language name to be more readable
                    const langMap = {
                        'py': 'Python',
                        'js': 'JavaScript',
                        'ts': 'TypeScript',
                        'html': 'HTML',
                        'css': 'CSS',
                        'yaml': 'YAML',
                        'json': 'JSON',
                        'bash': 'Shell',
                        'sh': 'Shell',
                        'sql': 'SQL',
                        'cpp': 'C++'
                    };

                    const displayLang = langMap[language] || language.charAt(0).toUpperCase() + language.slice(1);
                    langBadge.textContent = displayLang;
                    block.appendChild(langBadge);
                }
            });
        });
    </script>

    

    <!-- Extra scripts from plugins -->
    

    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>